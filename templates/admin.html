<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin · G School</title>
  <link rel="icon" href="https://blocked.gdistrict.org/favicon.png" type="image/png">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
  <style>
    body { max-width:1200px; margin:auto; padding:1rem }
    body, label, h3, h4, .mini, button, .btn { color:#000 !important; }
    table { width:100%; border-collapse:collapse; margin-top:10px }
    th, td { border:1px solid #ccc; padding:6px; text-align:left }
    td input[type="url"] { width:100% }
    .mini { font-size: 0.85rem; color:#444; }
    .flex-row { display:flex; flex-wrap:wrap; gap:1rem; align-items:flex-start; }
    .flex-1 { flex:1; min-width:260px; }
    .flex-2 { flex:2; min-width:320px; }
    ul#policiesList {
      list-style:none;
      padding-left:0;
      max-height:240px;
      overflow-y:auto;
      border:1px solid #ccc;
      border-radius:4px;
    }
    ul#policiesList li {
      padding:4px 8px;
      cursor:pointer;
    }
    ul#policiesList li:nth-child(odd) {
      background:#f9fafb;
    }
    ul#policiesList li.selected {
      background:#e0f2fe;
    }
    #policyCategoriesContainer {
      border:1px solid #ccc;
      border-radius:4px;
      padding:6px;
      max-height:140px;
      overflow-y:auto;
      background:#f9fafb;
    }
    #policyCategoriesContainer label {
      display:inline-block;
      margin-right:0.75rem;
      margin-bottom:0.15rem;
    }
    textarea {
      width:100%;
    }
  </style>
</head>
<body>
<nav>
  <ul><li><strong>Admin</strong></li></ul>
  <ul><li><a href="/teacher">Teacher</a></li><li><a href="/logout">Logout</a></li></ul>
</nav>

<h3>Settings</h3>
<article>
  <label>Default Blocked Redirect URL 
    <input id="blocked" type="url" value="{{ data.settings.blocked_redirect|default('https://blocked.gdistrict.org/Gschool%20block') }}">
  </label>
  <label>
    <input id="chat" type="checkbox" {{ 'checked' if data.settings.chat_enabled|default(False) else '' }}>
    Enable Chat
  </label>
  <label>Extension Passcode
    <input id="passcode" type="password" placeholder="admin1234">
  </label>
</article>
<article class="card">
  <h3>Bypass Overrides</h3>

  <label>
    <input id="bypassEnabled" type="checkbox">
    Enable Bypass Override on Block Pages
  </label>

  <hr>

  <h4>Create Temporary Bypass</h4>

  <label>Allowed Duration (minutes)
    <input id="bypassTTL" type="number" min="1" max="1440" value="10">
  </label>

  <label>User (optional)
    <input id="bypassUser" placeholder="student@school.org">
  </label>

  <label>Allowed URLs (optional, one per line)
    <textarea id="bypassUrls" rows="3" placeholder="https://youtube.com"></textarea>
  </label>

  <button id="createBypass">Generate Bypass Code</button>
  <span id="createMsg"></span>

  <hr>

  <h4>Active Bypass Codes</h4>
  <table id="bypassTable">
    <thead>
      <tr>
        <th>Code</th>
        <th>User</th>
        <th>Expires In</th>
        <th>URLs</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</article>

<h3>Policies</h3>
<article>
  <p class="mini">
    Policies control <b>all blocking</b> for students: AI categories and manual URLs.
    The Chrome extension sends the student’s identity to the GSchool server, and the server decides:
    <br>
    <b>1)</b> If there is a user-specific policy for that student email<br>
    <b>2)</b> Otherwise, if there is a class/group policy (not configured here yet)<br>
    <b>3)</b> Otherwise, the Default policy (if set)<br>
    Among all applicable policies, the one with the highest <b>Priority</b> that is currently active
    by its schedule is used.
  </p>

  <div class="flex-row">
    <!-- Policy list -->
    <div class="flex-1">
      <h4>Existing Policies</h4>
      <ul id="policiesList"></ul>
      <button id="newPolicyBtn" class="secondary">New Policy</button>
      <button id="deletePolicyBtn" class="secondary" style="background:#fee2e2;border-color:#fecaca;">Delete Selected</button>
      <p class="mini">
        Click a policy to edit. “(default)” means it’s the default when a student has no other policy.
      </p>
    </div>

    <!-- Policy editor -->
    <div class="flex-2">
      <h4>Edit Policy</h4>
      <div style="display:flex; flex-wrap:wrap; gap:1rem;">
        <label style="flex:1; min-width:220px;">
          Policy ID
          <input id="policyId" type="text" readonly placeholder="auto-generated for new">
        </label>
        <label style="flex:1; min-width:220px;">
          Policy Name
          <input id="policyName" type="text" placeholder="e.g. Exam Lockdown">
        </label>
      </div>

      <div style="display:flex; flex-wrap:wrap; gap:1rem; align-items:flex-end; margin-top:0.5rem;">
        <label style="flex:1; min-width:160px;">
          Priority
          <input id="policyPriority" type="number" value="0">
          <small class="mini">Higher number = wins when multiple policies apply.</small>
        </label>
        <label style="flex:none;">
          <input id="policyActive" type="checkbox" checked> Active
        </label>
        <label style="flex:1; min-width:160px;">
          Default for unassigned users?
          <select id="policyIsDefault">
            <option value="no">No</option>
            <option value="yes">Yes</option>
          </select>
        </label>
      </div>
      <p class="mini">
        <b>Currently default policy:</b> <span id="currentDefaultLabel">(none)</span>
      </p>

      <h4>Schedule (optional)</h4>
      <p class="mini">
        Use this to automatically turn this policy on/off at specific times. If disabled, the policy is
        always active (when “Active” is checked).
      </p>
      <div style="display:flex; flex-wrap:wrap; gap:1rem; align-items:flex-end;">
        <label>
          <input id="policyScheduleEnabled" type="checkbox"> Use schedule for this policy
        </label>
        <label>
          Start time
          <input id="policyStart" type="time">
        </label>
        <label>
          End time
          <input id="policyEnd" type="time">
        </label>
        <label>
          <input id="policyWeekdaysOnly" type="checkbox"> Weekdays only (Mon–Fri)
        </label>
      </div>

      <h4>Categories (from AI classify)</h4>
      <p class="mini">
        These categories come from the AI classifier. Check any category that this policy should
        <b>block</b>. Unchecked categories follow whatever other policy (or default) applies.
      </p>
      <div id="policyCategoriesContainer" class="mini">
        Loading AI categories…
      </div>

      <h4>Manual URLs</h4>
      <label>Block URLs (one per line, supports * wildcards)
        <textarea id="policyBlockUrls" rows="3" placeholder="e.g. *://*.games.com/*"></textarea>
      </label>
      <label>Allow URLs (one per line, supports * wildcards)
        <textarea id="policyAllowUrls" rows="3" placeholder="e.g. *://*.khanacademy.org/*"></textarea>
      </label>

      <h4>Student Emails for this Policy</h4>
      <p class="mini">
        These are the student emails that the Chrome extension uses when talking to the server.
        Each email here will have this policy applied, unless a higher-priority policy also applies.
      </p>
      <label>Student Emails (one per line)
        <textarea id="policyEmails" rows="4" placeholder="student1@example.com&#10;student2@example.com"></textarea>
      </label>

      <button id="savePolicyBtn">Save Policy</button>
      <small id="policiesMsg" class="mini" style="margin-left:8px;"></small>
    </div>
  </div>
</article>

<h3>AI Image Filter</h3>
<article>
  <details open>
    <summary>Realtime Image Safety Filter</summary>
    <p class="mini">
      The AI image filter runs inside the browser extension and calls the server
      in realtime to classify images on any website. Blocked images are blurred
      and replaced with a lock icon before students can see them.
    </p>

    <div class="grid">
      <label>
        <input id="imgFilterEnabled" type="checkbox">
        Enable AI image filter for students
      </label>

      <label>
        Mode
        <select id="imgFilterMode">
          <option value="block">Block &amp; blur images above threshold</option>
          <option value="monitor">Monitor only (log events, do not blur)</option>
        </select>
        <small class="mini">
          Monitor mode is useful for testing – you can see what <em>would</em> be blocked
          without affecting students.
        </small>
      </label>

      <label>
        Block threshold (0.1 – 0.99)
        <input id="imgFilterThreshold" type="number" step="0.01" min="0.1" max="0.99" value="0.60">
        <small class="mini">
          Lower = stricter (more images blocked). Higher = looser (fewer blocked).
        </small>
      </label>

      <label>
        <input id="imgFilterAlertOnBlock" type="checkbox" checked>
        Create an alert whenever an image is blocked
      </label>

      <label>
        Max events kept in log
        <input id="imgFilterMaxLog" type="number" min="100" max="5000" value="500">
        <small class="mini">
          Older events are automatically dropped when this limit is reached.
        </small>
      </label>
    </div>

    <button id="imgFilterSaveBtn" class="contrast" style="margin-top:0.5rem;">Save Image Filter Settings</button>
    <small id="imgFilterMsg" class="mini" style="margin-left:0.5rem;"></small>

    <hr>

    <h4>Recent Image Filter Events</h4>
    <p class="mini">
      These are the most recent images that the AI filter has evaluated and either blocked
      or monitored. New events automatically appear here in realtime while this page is open.
    </p>
    <table>
      <thead>
        <tr>
          <th>Time</th>
          <th>Student</th>
          <th>Action</th>
          <th>Reason</th>
          <th>Score</th>
          <th>Page / Image</th>
        </tr>
      </thead>
      <tbody id="imgFilterEventsBody">
      </tbody>
    </table>
  </details>
</article>

<!-- SIMPLE USER MANAGEMENT (no student stuff here) -->
<h3>Users</h3>
<article>
  <details open>
    <summary>Admin &amp; Teacher Accounts</summary>
    <p class="mini">
      Create / update / delete sign-in accounts for the teacher and admin dashboards.
      These accounts <b>do not</b> affect student extension logins.
    </p>

    <!-- Create / Update -->
    <h4>Create or Update User</h4>
    <label>Email
      <input type="email" id="userEmail" placeholder="teacher@example.com">
    </label>
    <label>Password
      <input type="password" id="userPassword" placeholder="Set or reset password">
    </label>
    <label>Role
      <select id="userRole">
        <option value="teacher">Teacher</option>
        <option value="admin">Admin</option>
      </select>
    </label>
    <button id="saveUser">Save User</button>
    <p id="userMsg" class="mini"></p>

    <hr>

    <!-- Delete -->
    <h4>Delete User</h4>
    <label>Email
      <input type="email" id="deleteEmail" placeholder="teacher@example.com">
    </label>
    <button id="deleteUser" class="secondary">Delete User</button>
    <p id="deleteMsg" class="mini"></p>
  </details>
</article>

<script>
(async function initAll() {
  // ========= SETTINGS =========
  const saveBtn = document.getElementById('save');
  const msgEl = document.getElementById('msg');
  if(saveBtn){
    saveBtn.onclick = async () => {
      try {
        const body = {
          blocked_redirect: document.getElementById('blocked')?.value,
          chat_enabled: document.getElementById('chat')?.checked,
          passcode: document.getElementById('passcode')?.value,
          bypass_enabled: document.getElementById('bypassEnabled')?.checked,
          bypass_code: document.getElementById('bypassCode')?.value,
          bypass_ttl_minutes: parseInt(document.getElementById('bypassTTL')?.value || '10',10)
        };
        const r = await fetch('/api/settings', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify(body)
        });
        if(msgEl){ msgEl.textContent = r.ok ? 'Saved' : 'Error'; msgEl.style.color = r.ok ? 'green' : 'crimson'; }
        setTimeout(()=>{ if(msgEl) msgEl.textContent=''; },1500);
      } catch(e){ console.error(e); if(msgEl){ msgEl.textContent='Error'; msgEl.style.color='crimson'; } }
    };
  }

  // ========= POLICIES =========
  let POLICIES = {};
  let ASSIGNMENTS = { users:{}, groups:{} };
  let DEFAULT_POLICY_ID = null;
  let CURRENT_POLICY_ID = null;
  let AI_CATEGORIES = [];

  function normalizeLines(val){ return val ? val.split(/\n/).map(s=>s.trim()).filter(Boolean) : []; }

  function renderPolicyCategoryCheckboxes(policy){
    const container = document.getElementById('policyCategoriesContainer');
    if(!container) return;
    const blockedSet = new Set((policy?.blocked_categories)||[]);
    if(!AI_CATEGORIES.length){
      container.textContent = 'No AI categories yet. Once the classifier has categories, they will appear here.';
      return;
    }
    container.innerHTML = '';
    AI_CATEGORIES.forEach(c=>{
      const label = document.createElement('label');
      const cb = document.createElement('input');
      cb.type='checkbox';
      cb.dataset.catName = c.name;
      if(blockedSet.has(c.name)) cb.checked = true;
      label.appendChild(cb);
      label.appendChild(document.createTextNode(' '+c.name));
      container.appendChild(label);
      container.appendChild(document.createElement('br'));
    });
  }

  function getEmailsForPolicy(pid){
    const emails = [];
    if(!ASSIGNMENTS?.users) return emails;
    Object.entries(ASSIGNMENTS.users).forEach(([email,assigned])=>{
      if(!assigned) return;
      if(Array.isArray(assigned)){
        if(assigned.map(String).includes(String(pid))) emails.push(email);
      } else if(String(assigned)===String(pid)){ emails.push(email); }
    });
    return emails;
  }

  function fillPolicyForm(p){
    const idEl = document.getElementById('policyId');
    const nameEl = document.getElementById('policyName');
    const prioEl = document.getElementById('policyPriority');
    const activeEl = document.getElementById('policyActive');
    const schedEnEl = document.getElementById('policyScheduleEnabled');
    const startEl = document.getElementById('policyStart');
    const endEl = document.getElementById('policyEnd');
    const wdEl = document.getElementById('policyWeekdaysOnly');
    const blockUrlsEl = document.getElementById('policyBlockUrls');
    const allowUrlsEl = document.getElementById('policyAllowUrls');
    const emailsEl = document.getElementById('policyEmails');
    const isDefEl = document.getElementById('policyIsDefault');

    if(!p){
      CURRENT_POLICY_ID=null;
      if(idEl) idEl.value='';
      if(nameEl) nameEl.value='';
      if(prioEl) prioEl.value='0';
      if(activeEl) activeEl.checked=true;
      if(schedEnEl) schedEnEl.checked=false;
      if(startEl) startEl.value='';
      if(endEl) endEl.value='';
      if(wdEl) wdEl.checked=false;
      if(blockUrlsEl) blockUrlsEl.value='';
      if(allowUrlsEl) allowUrlsEl.value='';
      if(emailsEl) emailsEl.value='';
      if(isDefEl) isDefEl.value='no';
      renderPolicyCategoryCheckboxes(null);
      return;
    }

    CURRENT_POLICY_ID = p.id || '';
    if(idEl) idEl.value = p.id || '';
    if(nameEl) nameEl.value = p.name || '';
    if(prioEl) prioEl.value = typeof p.priority==='number'?p.priority:0;
    if(activeEl) activeEl.checked = p.active!==false;
    const sched = p.schedule||{};
    if(schedEnEl) schedEnEl.checked=!!sched.enabled;
    if(startEl) startEl.value = sched.start||'';
    if(endEl) endEl.value = sched.end||'';
    if(wdEl) wdEl.checked = !!sched.weekdays_only;
    if(blockUrlsEl) blockUrlsEl.value = (p.block_urls||[]).join('\n');
    if(allowUrlsEl) allowUrlsEl.value = (p.allow_urls||[]).join('\n');
    if(emailsEl) emailsEl.value = getEmailsForPolicy(p.id||'').join('\n');
    if(isDefEl) isDefEl.value = (p.id && p.id===DEFAULT_POLICY_ID)?'yes':'no';
    renderPolicyCategoryCheckboxes(p);
  }

  function renderPoliciesList(){
    const ul = document.getElementById('policiesList');
    const defLabel = document.getElementById('currentDefaultLabel');
    if(!ul) return;
    ul.innerHTML='';
    const ids = Object.keys(POLICIES).sort((a,b)=>{
      const pa=POLICIES[a]||{},pb=POLICIES[b]||{};
      const da=pa.priority||0,db=pb.priority||0;
      if(da!==db) return db-da;
      return (pa.name||'').toLowerCase().localeCompare((pb.name||'').toLowerCase());
    });
    ids.forEach(id=>{
      const p = POLICIES[id];
      const li = document.createElement('li');
      let label = `${p.name||'(unnamed)'} [prio ${p.priority||0}]`;
      if(id===DEFAULT_POLICY_ID) label+=' (default)';
      li.textContent=label;
      li.dataset.id=id;
      li.onclick = ()=>{
        CURRENT_POLICY_ID = id;
        fillPolicyForm(POLICIES[id]);
        ul.querySelectorAll('li').forEach(el=>el.classList.remove('selected'));
        li.classList.add('selected');
      };
      ul.appendChild(li);
    });
    if(defLabel) defLabel.textContent = (DEFAULT_POLICY_ID && POLICIES[DEFAULT_POLICY_ID])?POLICIES[DEFAULT_POLICY_ID].name||DEFAULT_POLICY_ID:'(none)';
  }

  async function loadAiCategories(){
    try{
      const res = await fetch('/api/ai/categories');
      if(!res.ok) throw new Error('AI categories fetch failed');
      const j = await res.json();
      AI_CATEGORIES = j.categories||[];
    }catch(e){ console.warn(e); AI_CATEGORIES=[]; }
    renderPolicyCategoryCheckboxes(CURRENT_POLICY_ID?POLICIES[CURRENT_POLICY_ID]:null);
  }

  async function loadPolicyAssignments(){
    try{
      const r = await fetch('/api/policy_assignments');
      if(!r.ok) return;
      const j = await r.json();
      if(!j.ok) return;
      ASSIGNMENTS = j.policy_assignments||{users:{},groups:{}};
      DEFAULT_POLICY_ID = j.default_policy_id||null;
    }catch(e){ console.error('loadPolicyAssignments error', e); }
  }

  async function loadPoliciesUI(){
    try{
      const r = await fetch('/api/policies');
      if(!r.ok) return;
      const j = await r.json();
      if(!j.ok) return;
      POLICIES = j.policies||{};
      DEFAULT_POLICY_ID = j.default_policy_id||null;
      await loadPolicyAssignments();
      renderPoliciesList();
      const firstId = Object.keys(POLICIES)[0];
      fillPolicyForm(firstId?POLICIES[firstId]:null);
    }catch(e){ console.error('loadPoliciesUI error', e); }
  }

  // Save/Delete policy functions (same as your old code)
  // ... You can copy your existing saveCurrentPolicy() and deleteCurrentPolicy() here
  // Add event bindings:
  const savePolicyBtn = document.getElementById('savePolicyBtn');
  const newPolicyBtn = document.getElementById('newPolicyBtn');
  const deletePolicyBtn = document.getElementById('deletePolicyBtn');
  if(savePolicyBtn) savePolicyBtn.onclick = ev=>{ ev.preventDefault(); saveCurrentPolicy(); };
  if(newPolicyBtn) newPolicyBtn.onclick = ev=>{ ev.preventDefault(); fillPolicyForm(null); };
  if(deletePolicyBtn) deletePolicyBtn.onclick = ev=>{ ev.preventDefault(); deleteCurrentPolicy(); };

  // ========= USER MANAGEMENT =========
  const saveUserBtn = document.getElementById('saveUser');
  const deleteUserBtn = document.getElementById('deleteUser');
  if(saveUserBtn) saveUserBtn.onclick = async ()=>{
    const email = document.getElementById('userEmail')?.value.trim().toLowerCase();
    const password = document.getElementById('userPassword')?.value;
    const role = document.getElementById('userRole')?.value||'teacher';
    const msgEl = document.getElementById('userMsg');
    if(!email||!password){ if(msgEl){ msgEl.textContent='Email and password required'; msgEl.style.color='crimson'; } return; }
    try{
      const r = await fetch('/api/users',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password,role})});
      if(r.ok){ if(msgEl){ msgEl.textContent='User saved'; msgEl.style.color='green'; } document.getElementById('userPassword').value=''; }
      else{ const t = await r.text(); if(msgEl){ msgEl.textContent='Error: '+(t||'could not save user'); msgEl.style.color='crimson'; } }
    }catch(e){ console.error(e); }
  };
  if(deleteUserBtn) deleteUserBtn.onclick = async ()=>{
    const email = document.getElementById('deleteEmail')?.value.trim().toLowerCase();
    const msgEl = document.getElementById('deleteMsg');
    if(!email){ if(msgEl){ msgEl.textContent='Email required'; msgEl.style.color='crimson'; } return; }
    if(!confirm('Delete user '+email+'? This cannot be undone.')) return;
    try{
      const r = await fetch('/api/users/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email})});
      if(r.ok){ if(msgEl){ msgEl.textContent='User deleted (if existed)'; msgEl.style.color='green'; } }
      else{ const t=await r.text(); if(msgEl){ msgEl.textContent='Error: '+(t||'could not delete user'); msgEl.style.color='crimson'; } }
    }catch(e){ console.error(e); }
  };

  // ========= AI IMAGE FILTER =========
  let IMG_FILTER_CFG=null,IMG_FILTER_EVENTS=[],IMG_FILTER_POLL_TIMER=null;

  async function loadImageFilterConfig(){
    try{
      const r = await fetch('/api/image_filter/config');
      if(!r.ok) return;
      const j = await r.json();
      if(!j.ok) return;
      IMG_FILTER_CFG = j.config||{};
      const enabledEl = document.getElementById('imgFilterEnabled');
      const modeEl = document.getElementById('imgFilterMode');
      const thEl = document.getElementById('imgFilterThreshold');
      const alertEl = document.getElementById('imgFilterAlertOnBlock');
      const maxLogEl = document.getElementById('imgFilterMaxLog');
      if(enabledEl) enabledEl.checked=!!IMG_FILTER_CFG.enabled;
      if(modeEl && IMG_FILTER_CFG.mode) modeEl.value=IMG_FILTER_CFG.mode;
      if(thEl && typeof IMG_FILTER_CFG.block_threshold==='number') thEl.value=IMG_FILTER_CFG.block_threshold.toFixed(2);
      if(alertEl && 'alert_on_block' in IMG_FILTER_CFG) alertEl.checked=!!IMG_FILTER_CFG.alert_on_block;
      if(maxLogEl && IMG_FILTER_CFG.max_log_entries) maxLogEl.value=IMG_FILTER_CFG.max_log_entries;
    }catch(e){ console.error('loadImageFilterConfig error',e); }
  }

  async function saveImageFilterConfig(){
    const msgEl = document.getElementById('imgFilterMsg');
    if(msgEl){ msgEl.textContent=''; msgEl.style.color='#444'; }
    try{
      const enabledEl=document.getElementById('imgFilterEnabled');
      const modeEl=document.getElementById('imgFilterMode');
      const thEl=document.getElementById('imgFilterThreshold');
      const alertEl=document.getElementById('imgFilterAlertOnBlock');
      const maxLogEl=document.getElementById('imgFilterMaxLog');
      const body={
        enabled:enabledEl?.checked||false,
        mode:modeEl?.value||'block',
        alert_on_block:alertEl?.checked??true
      };
      if(thEl?.value) body.block_threshold=parseFloat(thEl.value);
      if(maxLogEl?.value) body.max_log_entries=parseInt(maxLogEl.value,10);
      const r = await fetch('/api/image_filter/config',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
      if(!r.ok){ const t=await r.text(); if(msgEl){ msgEl.textContent='Error: '+t; msgEl.style.color='crimson'; } return; }
      const j=await r.json();
      if(!j.ok){ if(msgEl){ msgEl.textContent='Error: '+(j.error||'unknown'); msgEl.style.color='crimson'; } return; }
      IMG_FILTER_CFG=j.config||{};
      if(msgEl){ msgEl.textContent='Saved.'; msgEl.style.color='green'; }
    }catch(e){ console.error(e); if(document.getElementById('imgFilterMsg')){document.getElementById('imgFilterMsg').textContent='Error: '+e; document.getElementById('imgFilterMsg').style.color='crimson';} }
  }

  async function pollImageFilterEventsOnce(){
    try{
      const r = await fetch('/api/image_filter/logs');
      if(!r.ok) return;
      const j = await r.json();
      if(!j.ok) return;
      IMG_FILTER_EVENTS=j.events||[];
      const tbody=document.getElementById('imgFilterEventsBody');
      if(!tbody) return;
      tbody.innerHTML='';
      IMG_FILTER_EVENTS.slice().reverse().forEach(ev=>{
        const tr=document.createElement('tr');
        const tdTime=document.createElement('td');
        const d=new Date((ev.ts||0)*1000);
        tdTime.textContent=d.toLocaleTimeString()+'\n'+d.toLocaleDateString();
        tdTime.className='mini';
        const tdStudent=document.createElement('td'); tdStudent.textContent=ev.student||''; tdStudent.className='mini';
        const tdAction=document.createElement('td'); tdAction.textContent=ev.action||''; tdAction.className='mini';
        const tdReason=document.createElement('td'); tdReason.textContent=ev.label||ev.reason||''; tdReason.className='mini';
        const tdScore=document.createElement('td'); tdScore.textContent=(typeof ev.score==='number'?ev.score.toFixed(2):''); tdScore.className='mini';
        const tdUrl=document.createElement('td'); const link=document.createElement('a'); link.href=ev.page_url||ev.src||'#'; link.textContent=(ev.page_url||ev.src||'').slice(0,80)||'(no url)'; link.target='_blank'; tdUrl.appendChild(link); tdUrl.className='mini';
        tr.appendChild(tdTime); tr.appendChild(tdStudent); tr.appendChild(tdAction); tr.appendChild(tdReason); tr.appendChild(tdScore); tr.appendChild(tdUrl);
        tbody.appendChild(tr);
      });
    }catch(e){ console.error(e); }
  }

  function startImageFilterPolling(){
    if(IMG_FILTER_POLL_TIMER){ clearInterval(IMG_FILTER_POLL_TIMER); IMG_FILTER_POLL_TIMER=null; }
    pollImageFilterEventsOnce();
    IMG_FILTER_POLL_TIMER=setInterval(pollImageFilterEventsOnce,10000);
  }

  const imgSaveBtn=document.getElementById('imgFilterSaveBtn');
  if(imgSaveBtn) imgSaveBtn.onclick=ev=>{ ev.preventDefault(); saveImageFilterConfig(); };
  try{ await loadImageFilterConfig(); startImageFilterPolling(); } catch(e){ console.error(e); }

  // ========= BYPASS =========
  async function api(url, body){ const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body||{})}); return r.json(); }

  const bypassEnabled=document.getElementById('bypassEnabled');
  const ttlInput=document.getElementById('bypassTTL');
  const userInput=document.getElementById('bypassUser');
  const urlsInput=document.getElementById('bypassUrls');
  const createBtn=document.getElementById('createBypass');
  const tableBody=document.querySelector('#bypassTable tbody');
  const msg=document.getElementById('createMsg');

  bypassEnabled?.addEventListener('change',async ()=>{ await api('/api/settings',{bypass_enabled:bypassEnabled.checked}); });

  createBtn?.addEventListener('click',async ()=>{
    if(!msg) return;
    msg.textContent='Generating…';
    const res = await api('/api/admin/create-bypass',{
      ttl_minutes: Number(ttlInput?.value||10),
      user: userInput?.value.trim(),
      urls: urlsInput?.value.split('\n').map(u=>u.trim()).filter(Boolean)
    });
    if(!res.ok){ msg.textContent=res.error||'Error'; msg.style.color='crimson'; return; }
    msg.textContent='Created';
    msg.style.color='green';
    loadBypasses();
  });

  async function loadBypasses(){
    if(!tableBody) return;
    const res = await fetch('/api/admin/bypasses'); if(!res.ok) return;
    const j = await res.json(); if(!j.ok) return;
    tableBody.innerHTML='';
    j.bypasses.forEach(b=>{
      const tr=document.createElement('tr');
      const tdUser=document.createElement('td'); tdUser.textContent=b.user; tr.appendChild(tdUser);
      const tdExpires=document.createElement('td'); tdExpires.textContent=new Date(b.expires*1000).toLocaleString(); tr.appendChild(tdExpires);
      const tdUrls=document.createElement('td'); tdUrls.textContent=(b.urls||[]).join('\n'); tr.appendChild(tdUrls);
      const tdDelete=document.createElement('td'); const delBtn=document.createElement('button'); delBtn.textContent='Delete';
      delBtn.onclick=async ()=>{ await api('/api/admin/delete-bypass',{id:b.id}); loadBypasses(); };
      tdDelete.appendChild(delBtn); tr.appendChild(tdDelete);
      tableBody.appendChild(tr);
    });
  }
  try{ await loadBypasses(); } catch(e){ console.error(e); }

})();
</script>
<script>
(async function initAll() {
  // ========= SETTINGS =========
  const saveBtn = document.getElementById('save');
  const msgEl = document.getElementById('msg');
  if(saveBtn){
    saveBtn.onclick = async () => {
      try {
        const body = {
          blocked_redirect: document.getElementById('blocked')?.value,
          chat_enabled: document.getElementById('chat')?.checked,
          passcode: document.getElementById('passcode')?.value,
          bypass_enabled: document.getElementById('bypassEnabled')?.checked,
          bypass_code: document.getElementById('bypassCode')?.value,
          bypass_ttl_minutes: parseInt(document.getElementById('bypassTTL')?.value || '10',10)
        };
        const r = await fetch('/api/settings', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify(body)
        });
        if(msgEl){ msgEl.textContent = r.ok ? 'Saved' : 'Error'; msgEl.style.color = r.ok ? 'green' : 'crimson'; }
        setTimeout(()=>{ if(msgEl) msgEl.textContent=''; },1500);
      } catch(e){ console.error(e); if(msgEl){ msgEl.textContent='Error'; msgEl.style.color='crimson'; } }
    };
  }

  // ========= POLICIES =========
  let POLICIES = {};
  let ASSIGNMENTS = { users:{}, groups:{} };
  let DEFAULT_POLICY_ID = null;
  let CURRENT_POLICY_ID = null;
  let AI_CATEGORIES = [];

  function normalizeLines(val){ return val ? val.split(/\n/).map(s=>s.trim()).filter(Boolean) : []; }

  function renderPolicyCategoryCheckboxes(policy){
    const container = document.getElementById('policyCategoriesContainer');
    if(!container) return;
    const blockedSet = new Set((policy?.blocked_categories)||[]);
    if(!AI_CATEGORIES.length){
      container.textContent = 'No AI categories yet. Once the classifier has categories, they will appear here.';
      return;
    }
    container.innerHTML = '';
    AI_CATEGORIES.forEach(c=>{
      const label = document.createElement('label');
      const cb = document.createElement('input');
      cb.type='checkbox';
      cb.dataset.catName = c.name;
      if(blockedSet.has(c.name)) cb.checked = true;
      label.appendChild(cb);
      label.appendChild(document.createTextNode(' '+c.name));
      container.appendChild(label);
      container.appendChild(document.createElement('br'));
    });
  }

  function getEmailsForPolicy(pid){
    const emails = [];
    if(!ASSIGNMENTS?.users) return emails;
    Object.entries(ASSIGNMENTS.users).forEach(([email,assigned])=>{
      if(!assigned) return;
      if(Array.isArray(assigned)){
        if(assigned.map(String).includes(String(pid))) emails.push(email);
      } else if(String(assigned)===String(pid)){ emails.push(email); }
    });
    return emails;
  }

  function fillPolicyForm(p){
    const idEl = document.getElementById('policyId');
    const nameEl = document.getElementById('policyName');
    const prioEl = document.getElementById('policyPriority');
    const activeEl = document.getElementById('policyActive');
    const schedEnEl = document.getElementById('policyScheduleEnabled');
    const startEl = document.getElementById('policyStart');
    const endEl = document.getElementById('policyEnd');
    const wdEl = document.getElementById('policyWeekdaysOnly');
    const blockUrlsEl = document.getElementById('policyBlockUrls');
    const allowUrlsEl = document.getElementById('policyAllowUrls');
    const emailsEl = document.getElementById('policyEmails');
    const isDefEl = document.getElementById('policyIsDefault');

    if(!p){
      CURRENT_POLICY_ID=null;
      if(idEl) idEl.value='';
      if(nameEl) nameEl.value='';
      if(prioEl) prioEl.value='0';
      if(activeEl) activeEl.checked=true;
      if(schedEnEl) schedEnEl.checked=false;
      if(startEl) startEl.value='';
      if(endEl) endEl.value='';
      if(wdEl) wdEl.checked=false;
      if(blockUrlsEl) blockUrlsEl.value='';
      if(allowUrlsEl) allowUrlsEl.value='';
      if(emailsEl) emailsEl.value='';
      if(isDefEl) isDefEl.value='no';
      renderPolicyCategoryCheckboxes(null);
      return;
    }

    CURRENT_POLICY_ID = p.id || '';
    if(idEl) idEl.value = p.id || '';
    if(nameEl) nameEl.value = p.name || '';
    if(prioEl) prioEl.value = typeof p.priority==='number'?p.priority:0;
    if(activeEl) activeEl.checked = p.active!==false;
    const sched = p.schedule||{};
    if(schedEnEl) schedEnEl.checked=!!sched.enabled;
    if(startEl) startEl.value = sched.start||'';
    if(endEl) endEl.value = sched.end||'';
    if(wdEl) wdEl.checked = !!sched.weekdays_only;
    if(blockUrlsEl) blockUrlsEl.value = (p.block_urls||[]).join('\n');
    if(allowUrlsEl) allowUrlsEl.value = (p.allow_urls||[]).join('\n');
    if(emailsEl) emailsEl.value = getEmailsForPolicy(p.id||'').join('\n');
    if(isDefEl) isDefEl.value = (p.id && p.id===DEFAULT_POLICY_ID)?'yes':'no';
    renderPolicyCategoryCheckboxes(p);
  }

  function renderPoliciesList(){
    const ul = document.getElementById('policiesList');
    const defLabel = document.getElementById('currentDefaultLabel');
    if(!ul) return;
    ul.innerHTML='';
    const ids = Object.keys(POLICIES).sort((a,b)=>{
      const pa=POLICIES[a]||{},pb=POLICIES[b]||{};
      const da=pa.priority||0,db=pb.priority||0;
      if(da!==db) return db-da;
      return (pa.name||'').toLowerCase().localeCompare((pb.name||'').toLowerCase());
    });
    ids.forEach(id=>{
      const p = POLICIES[id];
      const li = document.createElement('li');
      let label = `${p.name||'(unnamed)'} [prio ${p.priority||0}]`;
      if(id===DEFAULT_POLICY_ID) label+=' (default)';
      li.textContent=label;
      li.dataset.id=id;
      li.onclick = ()=>{
        CURRENT_POLICY_ID = id;
        fillPolicyForm(POLICIES[id]);
        ul.querySelectorAll('li').forEach(el=>el.classList.remove('selected'));
        li.classList.add('selected');
      };
      ul.appendChild(li);
    });
    if(defLabel) defLabel.textContent = (DEFAULT_POLICY_ID && POLICIES[DEFAULT_POLICY_ID])?POLICIES[DEFAULT_POLICY_ID].name||DEFAULT_POLICY_ID:'(none)';
  }

  async function loadAiCategories(){
    try{
      const res = await fetch('/api/ai/categories');
      if(!res.ok) throw new Error('AI categories fetch failed');
      const j = await res.json();
      AI_CATEGORIES = j.categories||[];
    }catch(e){ console.warn(e); AI_CATEGORIES=[]; }
    renderPolicyCategoryCheckboxes(CURRENT_POLICY_ID?POLICIES[CURRENT_POLICY_ID]:null);
  }

  async function loadPolicyAssignments(){
    try{
      const r = await fetch('/api/policy_assignments');
      if(!r.ok) return;
      const j = await r.json();
      if(!j.ok) return;
      ASSIGNMENTS = j.policy_assignments||{users:{},groups:{}};
      DEFAULT_POLICY_ID = j.default_policy_id||null;
    }catch(e){ console.error('loadPolicyAssignments error', e); }
  }

  async function loadPoliciesUI(){
    try{
      const r = await fetch('/api/policies');
      if(!r.ok) return;
      const j = await r.json();
      if(!j.ok) return;
      POLICIES = j.policies||{};
      DEFAULT_POLICY_ID = j.default_policy_id||null;
      await loadPolicyAssignments();
      renderPoliciesList();
      const firstId = Object.keys(POLICIES)[0];
      fillPolicyForm(firstId?POLICIES[firstId]:null);
    }catch(e){ console.error('loadPoliciesUI error', e); }
  }

  // Save/Delete policy functions (same as your old code)
  // ... You can copy your existing saveCurrentPolicy() and deleteCurrentPolicy() here
  // Add event bindings:
  const savePolicyBtn = document.getElementById('savePolicyBtn');
  const newPolicyBtn = document.getElementById('newPolicyBtn');
  const deletePolicyBtn = document.getElementById('deletePolicyBtn');
  if(savePolicyBtn) savePolicyBtn.onclick = ev=>{ ev.preventDefault(); saveCurrentPolicy(); };
  if(newPolicyBtn) newPolicyBtn.onclick = ev=>{ ev.preventDefault(); fillPolicyForm(null); };
  if(deletePolicyBtn) deletePolicyBtn.onclick = ev=>{ ev.preventDefault(); deleteCurrentPolicy(); };

  // ========= USER MANAGEMENT =========
  const saveUserBtn = document.getElementById('saveUser');
  const deleteUserBtn = document.getElementById('deleteUser');
  if(saveUserBtn) saveUserBtn.onclick = async ()=>{
    const email = document.getElementById('userEmail')?.value.trim().toLowerCase();
    const password = document.getElementById('userPassword')?.value;
    const role = document.getElementById('userRole')?.value||'teacher';
    const msgEl = document.getElementById('userMsg');
    if(!email||!password){ if(msgEl){ msgEl.textContent='Email and password required'; msgEl.style.color='crimson'; } return; }
    try{
      const r = await fetch('/api/users',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password,role})});
      if(r.ok){ if(msgEl){ msgEl.textContent='User saved'; msgEl.style.color='green'; } document.getElementById('userPassword').value=''; }
      else{ const t = await r.text(); if(msgEl){ msgEl.textContent='Error: '+(t||'could not save user'); msgEl.style.color='crimson'; } }
    }catch(e){ console.error(e); }
  };
  if(deleteUserBtn) deleteUserBtn.onclick = async ()=>{
    const email = document.getElementById('deleteEmail')?.value.trim().toLowerCase();
    const msgEl = document.getElementById('deleteMsg');
    if(!email){ if(msgEl){ msgEl.textContent='Email required'; msgEl.style.color='crimson'; } return; }
    if(!confirm('Delete user '+email+'? This cannot be undone.')) return;
    try{
      const r = await fetch('/api/users/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email})});
      if(r.ok){ if(msgEl){ msgEl.textContent='User deleted (if existed)'; msgEl.style.color='green'; } }
      else{ const t=await r.text(); if(msgEl){ msgEl.textContent='Error: '+(t||'could not delete user'); msgEl.style.color='crimson'; } }
    }catch(e){ console.error(e); }
  };

  // ========= AI IMAGE FILTER =========
  let IMG_FILTER_CFG=null,IMG_FILTER_EVENTS=[],IMG_FILTER_POLL_TIMER=null;

  async function loadImageFilterConfig(){
    try{
      const r = await fetch('/api/image_filter/config');
      if(!r.ok) return;
      const j = await r.json();
      if(!j.ok) return;
      IMG_FILTER_CFG = j.config||{};
      const enabledEl = document.getElementById('imgFilterEnabled');
      const modeEl = document.getElementById('imgFilterMode');
      const thEl = document.getElementById('imgFilterThreshold');
      const alertEl = document.getElementById('imgFilterAlertOnBlock');
      const maxLogEl = document.getElementById('imgFilterMaxLog');
      if(enabledEl) enabledEl.checked=!!IMG_FILTER_CFG.enabled;
      if(modeEl && IMG_FILTER_CFG.mode) modeEl.value=IMG_FILTER_CFG.mode;
      if(thEl && typeof IMG_FILTER_CFG.block_threshold==='number') thEl.value=IMG_FILTER_CFG.block_threshold.toFixed(2);
      if(alertEl && 'alert_on_block' in IMG_FILTER_CFG) alertEl.checked=!!IMG_FILTER_CFG.alert_on_block;
      if(maxLogEl && IMG_FILTER_CFG.max_log_entries) maxLogEl.value=IMG_FILTER_CFG.max_log_entries;
    }catch(e){ console.error('loadImageFilterConfig error',e); }
  }

  async function saveImageFilterConfig(){
    const msgEl = document.getElementById('imgFilterMsg');
    if(msgEl){ msgEl.textContent=''; msgEl.style.color='#444'; }
    try{
      const enabledEl=document.getElementById('imgFilterEnabled');
      const modeEl=document.getElementById('imgFilterMode');
      const thEl=document.getElementById('imgFilterThreshold');
      const alertEl=document.getElementById('imgFilterAlertOnBlock');
      const maxLogEl=document.getElementById('imgFilterMaxLog');
      const body={
        enabled:enabledEl?.checked||false,
        mode:modeEl?.value||'block',
        alert_on_block:alertEl?.checked??true
      };
      if(thEl?.value) body.block_threshold=parseFloat(thEl.value);
      if(maxLogEl?.value) body.max_log_entries=parseInt(maxLogEl.value,10);
      const r = await fetch('/api/image_filter/config',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
      if(!r.ok){ const t=await r.text(); if(msgEl){ msgEl.textContent='Error: '+t; msgEl.style.color='crimson'; } return; }
      const j=await r.json();
      if(!j.ok){ if(msgEl){ msgEl.textContent='Error: '+(j.error||'unknown'); msgEl.style.color='crimson'; } return; }
      IMG_FILTER_CFG=j.config||{};
      if(msgEl){ msgEl.textContent='Saved.'; msgEl.style.color='green'; }
    }catch(e){ console.error(e); if(document.getElementById('imgFilterMsg')){document.getElementById('imgFilterMsg').textContent='Error: '+e; document.getElementById('imgFilterMsg').style.color='crimson';} }
  }

  async function pollImageFilterEventsOnce(){
    try{
      const r = await fetch('/api/image_filter/logs');
      if(!r.ok) return;
      const j = await r.json();
      if(!j.ok) return;
      IMG_FILTER_EVENTS=j.events||[];
      const tbody=document.getElementById('imgFilterEventsBody');
      if(!tbody) return;
      tbody.innerHTML='';
      IMG_FILTER_EVENTS.slice().reverse().forEach(ev=>{
        const tr=document.createElement('tr');
        const tdTime=document.createElement('td');
        const d=new Date((ev.ts||0)*1000);
        tdTime.textContent=d.toLocaleTimeString()+'\n'+d.toLocaleDateString();
        tdTime.className='mini';
        const tdStudent=document.createElement('td'); tdStudent.textContent=ev.student||''; tdStudent.className='mini';
        const tdAction=document.createElement('td'); tdAction.textContent=ev.action||''; tdAction.className='mini';
        const tdReason=document.createElement('td'); tdReason.textContent=ev.label||ev.reason||''; tdReason.className='mini';
        const tdScore=document.createElement('td'); tdScore.textContent=(typeof ev.score==='number'?ev.score.toFixed(2):''); tdScore.className='mini';
        const tdUrl=document.createElement('td'); const link=document.createElement('a'); link.href=ev.page_url||ev.src||'#'; link.textContent=(ev.page_url||ev.src||'').slice(0,80)||'(no url)'; link.target='_blank'; tdUrl.appendChild(link); tdUrl.className='mini';
        tr.appendChild(tdTime); tr.appendChild(tdStudent); tr.appendChild(tdAction); tr.appendChild(tdReason); tr.appendChild(tdScore); tr.appendChild(tdUrl);
        tbody.appendChild(tr);
      });
    }catch(e){ console.error(e); }
  }

  function startImageFilterPolling(){
    if(IMG_FILTER_POLL_TIMER){ clearInterval(IMG_FILTER_POLL_TIMER); IMG_FILTER_POLL_TIMER=null; }
    pollImageFilterEventsOnce();
    IMG_FILTER_POLL_TIMER=setInterval(pollImageFilterEventsOnce,10000);
  }

  const imgSaveBtn=document.getElementById('imgFilterSaveBtn');
  if(imgSaveBtn) imgSaveBtn.onclick=ev=>{ ev.preventDefault(); saveImageFilterConfig(); };
  try{ await loadImageFilterConfig(); startImageFilterPolling(); } catch(e){ console.error(e); }

  // ========= BYPASS =========
  async function api(url, body){ const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body||{})}); return r.json(); }

  const bypassEnabled=document.getElementById('bypassEnabled');
  const ttlInput=document.getElementById('bypassTTL');
  const userInput=document.getElementById('bypassUser');
  const urlsInput=document.getElementById('bypassUrls');
  const createBtn=document.getElementById('createBypass');
  const tableBody=document.querySelector('#bypassTable tbody');
  const msg=document.getElementById('createMsg');

  bypassEnabled?.addEventListener('change',async ()=>{ await api('/api/settings',{bypass_enabled:bypassEnabled.checked}); });

  createBtn?.addEventListener('click',async ()=>{
    if(!msg) return;
    msg.textContent='Generating…';
    const res = await api('/api/admin/create-bypass',{
      ttl_minutes: Number(ttlInput?.value||10),
      user: userInput?.value.trim(),
      urls: urlsInput?.value.split('\n').map(u=>u.trim()).filter(Boolean)
    });
    if(!res.ok){ msg.textContent=res.error||'Error'; msg.style.color='crimson'; return; }
    msg.textContent='Created';
    msg.style.color='green';
    loadBypasses();
  });

  async function loadBypasses(){
    if(!tableBody) return;
    const res = await fetch('/api/admin/bypasses'); if(!res.ok) return;
    const j = await res.json(); if(!j.ok) return;
    tableBody.innerHTML='';
    j.bypasses.forEach(b=>{
      const tr=document.createElement('tr');
      const tdUser=document.createElement('td'); tdUser.textContent=b.user; tr.appendChild(tdUser);
      const tdExpires=document.createElement('td'); tdExpires.textContent=new Date(b.expires*1000).toLocaleString(); tr.appendChild(tdExpires);
      const tdUrls=document.createElement('td'); tdUrls.textContent=(b.urls||[]).join('\n'); tr.appendChild(tdUrls);
      const tdDelete=document.createElement('td'); const delBtn=document.createElement('button'); delBtn.textContent='Delete';
      delBtn.onclick=async ()=>{ await api('/api/admin/delete-bypass',{id:b.id}); loadBypasses(); };
      tdDelete.appendChild(delBtn); tr.appendChild(tdDelete);
      tableBody.appendChild(tr);
    });
  }
  try{ await loadBypasses(); } catch(e){ console.error(e); }

})();
</script>
<script>
(async function initAll() {
  // ========= SETTINGS =========
  const saveBtn = document.getElementById('save');
  const msgEl = document.getElementById('msg');
  if(saveBtn){
    saveBtn.onclick = async () => {
      try {
        const body = {
          blocked_redirect: document.getElementById('blocked')?.value,
          chat_enabled: document.getElementById('chat')?.checked,
          passcode: document.getElementById('passcode')?.value,
          bypass_enabled: document.getElementById('bypassEnabled')?.checked,
          bypass_code: document.getElementById('bypassCode')?.value,
          bypass_ttl_minutes: parseInt(document.getElementById('bypassTTL')?.value || '10',10)
        };
        const r = await fetch('/api/settings', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify(body)
        });
        if(msgEl){ msgEl.textContent = r.ok ? 'Saved' : 'Error'; msgEl.style.color = r.ok ? 'green' : 'crimson'; }
        setTimeout(()=>{ if(msgEl) msgEl.textContent=''; },1500);
      } catch(e){ console.error(e); if(msgEl){ msgEl.textContent='Error'; msgEl.style.color='crimson'; } }
    };
  }

  // ========= POLICIES =========
  let POLICIES = {};
  let ASSIGNMENTS = { users:{}, groups:{} };
  let DEFAULT_POLICY_ID = null;
  let CURRENT_POLICY_ID = null;
  let AI_CATEGORIES = [];

  function normalizeLines(val){ return val ? val.split(/\n/).map(s=>s.trim()).filter(Boolean) : []; }

  function renderPolicyCategoryCheckboxes(policy){
    const container = document.getElementById('policyCategoriesContainer');
    if(!container) return;
    const blockedSet = new Set((policy?.blocked_categories)||[]);
    if(!AI_CATEGORIES.length){
      container.textContent = 'No AI categories yet. Once the classifier has categories, they will appear here.';
      return;
    }
    container.innerHTML = '';
    AI_CATEGORIES.forEach(c=>{
      const label = document.createElement('label');
      const cb = document.createElement('input');
      cb.type='checkbox';
      cb.dataset.catName = c.name;
      if(blockedSet.has(c.name)) cb.checked = true;
      label.appendChild(cb);
      label.appendChild(document.createTextNode(' '+c.name));
      container.appendChild(label);
      container.appendChild(document.createElement('br'));
    });
  }

  function getEmailsForPolicy(pid){
    const emails = [];
    if(!ASSIGNMENTS?.users) return emails;
    Object.entries(ASSIGNMENTS.users).forEach(([email,assigned])=>{
      if(!assigned) return;
      if(Array.isArray(assigned)){
        if(assigned.map(String).includes(String(pid))) emails.push(email);
      } else if(String(assigned)===String(pid)){ emails.push(email); }
    });
    return emails;
  }

  function fillPolicyForm(p){
    const idEl = document.getElementById('policyId');
    const nameEl = document.getElementById('policyName');
    const prioEl = document.getElementById('policyPriority');
    const activeEl = document.getElementById('policyActive');
    const schedEnEl = document.getElementById('policyScheduleEnabled');
    const startEl = document.getElementById('policyStart');
    const endEl = document.getElementById('policyEnd');
    const wdEl = document.getElementById('policyWeekdaysOnly');
    const blockUrlsEl = document.getElementById('policyBlockUrls');
    const allowUrlsEl = document.getElementById('policyAllowUrls');
    const emailsEl = document.getElementById('policyEmails');
    const isDefEl = document.getElementById('policyIsDefault');

    if(!p){
      CURRENT_POLICY_ID=null;
      if(idEl) idEl.value='';
      if(nameEl) nameEl.value='';
      if(prioEl) prioEl.value='0';
      if(activeEl) activeEl.checked=true;
      if(schedEnEl) schedEnEl.checked=false;
      if(startEl) startEl.value='';
      if(endEl) endEl.value='';
      if(wdEl) wdEl.checked=false;
      if(blockUrlsEl) blockUrlsEl.value='';
      if(allowUrlsEl) allowUrlsEl.value='';
      if(emailsEl) emailsEl.value='';
      if(isDefEl) isDefEl.value='no';
      renderPolicyCategoryCheckboxes(null);
      return;
    }

    CURRENT_POLICY_ID = p.id || '';
    if(idEl) idEl.value = p.id || '';
    if(nameEl) nameEl.value = p.name || '';
    if(prioEl) prioEl.value = typeof p.priority==='number'?p.priority:0;
    if(activeEl) activeEl.checked = p.active!==false;
    const sched = p.schedule||{};
    if(schedEnEl) schedEnEl.checked=!!sched.enabled;
    if(startEl) startEl.value = sched.start||'';
    if(endEl) endEl.value = sched.end||'';
    if(wdEl) wdEl.checked = !!sched.weekdays_only;
    if(blockUrlsEl) blockUrlsEl.value = (p.block_urls||[]).join('\n');
    if(allowUrlsEl) allowUrlsEl.value = (p.allow_urls||[]).join('\n');
    if(emailsEl) emailsEl.value = getEmailsForPolicy(p.id||'').join('\n');
    if(isDefEl) isDefEl.value = (p.id && p.id===DEFAULT_POLICY_ID)?'yes':'no';
    renderPolicyCategoryCheckboxes(p);
  }

  function renderPoliciesList(){
    const ul = document.getElementById('policiesList');
    const defLabel = document.getElementById('currentDefaultLabel');
    if(!ul) return;
    ul.innerHTML='';
    const ids = Object.keys(POLICIES).sort((a,b)=>{
      const pa=POLICIES[a]||{},pb=POLICIES[b]||{};
      const da=pa.priority||0,db=pb.priority||0;
      if(da!==db) return db-da;
      return (pa.name||'').toLowerCase().localeCompare((pb.name||'').toLowerCase());
    });
    ids.forEach(id=>{
      const p = POLICIES[id];
      const li = document.createElement('li');
      let label = `${p.name||'(unnamed)'} [prio ${p.priority||0}]`;
      if(id===DEFAULT_POLICY_ID) label+=' (default)';
      li.textContent=label;
      li.dataset.id=id;
      li.onclick = ()=>{
        CURRENT_POLICY_ID = id;
        fillPolicyForm(POLICIES[id]);
        ul.querySelectorAll('li').forEach(el=>el.classList.remove('selected'));
        li.classList.add('selected');
      };
      ul.appendChild(li);
    });
    if(defLabel) defLabel.textContent = (DEFAULT_POLICY_ID && POLICIES[DEFAULT_POLICY_ID])?POLICIES[DEFAULT_POLICY_ID].name||DEFAULT_POLICY_ID:'(none)';
  }

  async function loadAiCategories(){
    try{
      const res = await fetch('/api/ai/categories');
      if(!res.ok) throw new Error('AI categories fetch failed');
      const j = await res.json();
      AI_CATEGORIES = j.categories||[];
    }catch(e){ console.warn(e); AI_CATEGORIES=[]; }
    renderPolicyCategoryCheckboxes(CURRENT_POLICY_ID?POLICIES[CURRENT_POLICY_ID]:null);
  }

  async function loadPolicyAssignments(){
    try{
      const r = await fetch('/api/policy_assignments');
      if(!r.ok) return;
      const j = await r.json();
      if(!j.ok) return;
      ASSIGNMENTS = j.policy_assignments||{users:{},groups:{}};
      DEFAULT_POLICY_ID = j.default_policy_id||null;
    }catch(e){ console.error('loadPolicyAssignments error', e); }
  }

  async function loadPoliciesUI(){
    try{
      const r = await fetch('/api/policies');
      if(!r.ok) return;
      const j = await r.json();
      if(!j.ok) return;
      POLICIES = j.policies||{};
      DEFAULT_POLICY_ID = j.default_policy_id||null;
      await loadPolicyAssignments();
      renderPoliciesList();
      const firstId = Object.keys(POLICIES)[0];
      fillPolicyForm(firstId?POLICIES[firstId]:null);
    }catch(e){ console.error('loadPoliciesUI error', e); }
  }

  // Save/Delete policy functions (same as your old code)
  // ... You can copy your existing saveCurrentPolicy() and deleteCurrentPolicy() here
  // Add event bindings:
  const savePolicyBtn = document.getElementById('savePolicyBtn');
  const newPolicyBtn = document.getElementById('newPolicyBtn');
  const deletePolicyBtn = document.getElementById('deletePolicyBtn');
  if(savePolicyBtn) savePolicyBtn.onclick = ev=>{ ev.preventDefault(); saveCurrentPolicy(); };
  if(newPolicyBtn) newPolicyBtn.onclick = ev=>{ ev.preventDefault(); fillPolicyForm(null); };
  if(deletePolicyBtn) deletePolicyBtn.onclick = ev=>{ ev.preventDefault(); deleteCurrentPolicy(); };

  // ========= USER MANAGEMENT =========
  const saveUserBtn = document.getElementById('saveUser');
  const deleteUserBtn = document.getElementById('deleteUser');
  if(saveUserBtn) saveUserBtn.onclick = async ()=>{
    const email = document.getElementById('userEmail')?.value.trim().toLowerCase();
    const password = document.getElementById('userPassword')?.value;
    const role = document.getElementById('userRole')?.value||'teacher';
    const msgEl = document.getElementById('userMsg');
    if(!email||!password){ if(msgEl){ msgEl.textContent='Email and password required'; msgEl.style.color='crimson'; } return; }
    try{
      const r = await fetch('/api/users',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password,role})});
      if(r.ok){ if(msgEl){ msgEl.textContent='User saved'; msgEl.style.color='green'; } document.getElementById('userPassword').value=''; }
      else{ const t = await r.text(); if(msgEl){ msgEl.textContent='Error: '+(t||'could not save user'); msgEl.style.color='crimson'; } }
    }catch(e){ console.error(e); }
  };
  if(deleteUserBtn) deleteUserBtn.onclick = async ()=>{
    const email = document.getElementById('deleteEmail')?.value.trim().toLowerCase();
    const msgEl = document.getElementById('deleteMsg');
    if(!email){ if(msgEl){ msgEl.textContent='Email required'; msgEl.style.color='crimson'; } return; }
    if(!confirm('Delete user '+email+'? This cannot be undone.')) return;
    try{
      const r = await fetch('/api/users/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email})});
      if(r.ok){ if(msgEl){ msgEl.textContent='User deleted (if existed)'; msgEl.style.color='green'; } }
      else{ const t=await r.text(); if(msgEl){ msgEl.textContent='Error: '+(t||'could not delete user'); msgEl.style.color='crimson'; } }
    }catch(e){ console.error(e); }
  };

  // ========= AI IMAGE FILTER =========
  let IMG_FILTER_CFG=null,IMG_FILTER_EVENTS=[],IMG_FILTER_POLL_TIMER=null;

  async function loadImageFilterConfig(){
    try{
      const r = await fetch('/api/image_filter/config');
      if(!r.ok) return;
      const j = await r.json();
      if(!j.ok) return;
      IMG_FILTER_CFG = j.config||{};
      const enabledEl = document.getElementById('imgFilterEnabled');
      const modeEl = document.getElementById('imgFilterMode');
      const thEl = document.getElementById('imgFilterThreshold');
      const alertEl = document.getElementById('imgFilterAlertOnBlock');
      const maxLogEl = document.getElementById('imgFilterMaxLog');
      if(enabledEl) enabledEl.checked=!!IMG_FILTER_CFG.enabled;
      if(modeEl && IMG_FILTER_CFG.mode) modeEl.value=IMG_FILTER_CFG.mode;
      if(thEl && typeof IMG_FILTER_CFG.block_threshold==='number') thEl.value=IMG_FILTER_CFG.block_threshold.toFixed(2);
      if(alertEl && 'alert_on_block' in IMG_FILTER_CFG) alertEl.checked=!!IMG_FILTER_CFG.alert_on_block;
      if(maxLogEl && IMG_FILTER_CFG.max_log_entries) maxLogEl.value=IMG_FILTER_CFG.max_log_entries;
    }catch(e){ console.error('loadImageFilterConfig error',e); }
  }

  async function saveImageFilterConfig(){
    const msgEl = document.getElementById('imgFilterMsg');
    if(msgEl){ msgEl.textContent=''; msgEl.style.color='#444'; }
    try{
      const enabledEl=document.getElementById('imgFilterEnabled');
      const modeEl=document.getElementById('imgFilterMode');
      const thEl=document.getElementById('imgFilterThreshold');
      const alertEl=document.getElementById('imgFilterAlertOnBlock');
      const maxLogEl=document.getElementById('imgFilterMaxLog');
      const body={
        enabled:enabledEl?.checked||false,
        mode:modeEl?.value||'block',
        alert_on_block:alertEl?.checked??true
      };
      if(thEl?.value) body.block_threshold=parseFloat(thEl.value);
      if(maxLogEl?.value) body.max_log_entries=parseInt(maxLogEl.value,10);
      const r = await fetch('/api/image_filter/config',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
      if(!r.ok){ const t=await r.text(); if(msgEl){ msgEl.textContent='Error: '+t; msgEl.style.color='crimson'; } return; }
      const j=await r.json();
      if(!j.ok){ if(msgEl){ msgEl.textContent='Error: '+(j.error||'unknown'); msgEl.style.color='crimson'; } return; }
      IMG_FILTER_CFG=j.config||{};
      if(msgEl){ msgEl.textContent='Saved.'; msgEl.style.color='green'; }
    }catch(e){ console.error(e); if(document.getElementById('imgFilterMsg')){document.getElementById('imgFilterMsg').textContent='Error: '+e; document.getElementById('imgFilterMsg').style.color='crimson';} }
  }

  async function pollImageFilterEventsOnce(){
    try{
      const r = await fetch('/api/image_filter/logs');
      if(!r.ok) return;
      const j = await r.json();
      if(!j.ok) return;
      IMG_FILTER_EVENTS=j.events||[];
      const tbody=document.getElementById('imgFilterEventsBody');
      if(!tbody) return;
      tbody.innerHTML='';
      IMG_FILTER_EVENTS.slice().reverse().forEach(ev=>{
        const tr=document.createElement('tr');
        const tdTime=document.createElement('td');
        const d=new Date((ev.ts||0)*1000);
        tdTime.textContent=d.toLocaleTimeString()+'\n'+d.toLocaleDateString();
        tdTime.className='mini';
        const tdStudent=document.createElement('td'); tdStudent.textContent=ev.student||''; tdStudent.className='mini';
        const tdAction=document.createElement('td'); tdAction.textContent=ev.action||''; tdAction.className='mini';
        const tdReason=document.createElement('td'); tdReason.textContent=ev.label||ev.reason||''; tdReason.className='mini';
        const tdScore=document.createElement('td'); tdScore.textContent=(typeof ev.score==='number'?ev.score.toFixed(2):''); tdScore.className='mini';
        const tdUrl=document.createElement('td'); const link=document.createElement('a'); link.href=ev.page_url||ev.src||'#'; link.textContent=(ev.page_url||ev.src||'').slice(0,80)||'(no url)'; link.target='_blank'; tdUrl.appendChild(link); tdUrl.className='mini';
        tr.appendChild(tdTime); tr.appendChild(tdStudent); tr.appendChild(tdAction); tr.appendChild(tdReason); tr.appendChild(tdScore); tr.appendChild(tdUrl);
        tbody.appendChild(tr);
      });
    }catch(e){ console.error(e); }
  }

  function startImageFilterPolling(){
    if(IMG_FILTER_POLL_TIMER){ clearInterval(IMG_FILTER_POLL_TIMER); IMG_FILTER_POLL_TIMER=null; }
    pollImageFilterEventsOnce();
    IMG_FILTER_POLL_TIMER=setInterval(pollImageFilterEventsOnce,10000);
  }

  const imgSaveBtn=document.getElementById('imgFilterSaveBtn');
  if(imgSaveBtn) imgSaveBtn.onclick=ev=>{ ev.preventDefault(); saveImageFilterConfig(); };
  try{ await loadImageFilterConfig(); startImageFilterPolling(); } catch(e){ console.error(e); }

  // ========= BYPASS =========
  async function api(url, body){ const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body||{})}); return r.json(); }

  const bypassEnabled=document.getElementById('bypassEnabled');
  const ttlInput=document.getElementById('bypassTTL');
  const userInput=document.getElementById('bypassUser');
  const urlsInput=document.getElementById('bypassUrls');
  const createBtn=document.getElementById('createBypass');
  const tableBody=document.querySelector('#bypassTable tbody');
  const msg=document.getElementById('createMsg');

  bypassEnabled?.addEventListener('change',async ()=>{ await api('/api/settings',{bypass_enabled:bypassEnabled.checked}); });

  createBtn?.addEventListener('click',async ()=>{
    if(!msg) return;
    msg.textContent='Generating…';
    const res = await api('/api/admin/create-bypass',{
      ttl_minutes: Number(ttlInput?.value||10),
      user: userInput?.value.trim(),
      urls: urlsInput?.value.split('\n').map(u=>u.trim()).filter(Boolean)
    });
    if(!res.ok){ msg.textContent=res.error||'Error'; msg.style.color='crimson'; return; }
    msg.textContent='Created';
    msg.style.color='green';
    loadBypasses();
  });

  async function loadBypasses(){
    if(!tableBody) return;
    const res = await fetch('/api/admin/bypasses'); if(!res.ok) return;
    const j = await res.json(); if(!j.ok) return;
    tableBody.innerHTML='';
    j.bypasses.forEach(b=>{
      const tr=document.createElement('tr');
      const tdUser=document.createElement('td'); tdUser.textContent=b.user; tr.appendChild(tdUser);
      const tdExpires=document.createElement('td'); tdExpires.textContent=new Date(b.expires*1000).toLocaleString(); tr.appendChild(tdExpires);
      const tdUrls=document.createElement('td'); tdUrls.textContent=(b.urls||[]).join('\n'); tr.appendChild(tdUrls);
      const tdDelete=document.createElement('td'); const delBtn=document.createElement('button'); delBtn.textContent='Delete';
      delBtn.onclick=async ()=>{ await api('/api/admin/delete-bypass',{id:b.id}); loadBypasses(); };
      tdDelete.appendChild(delBtn); tr.appendChild(tdDelete);
      tableBody.appendChild(tr);
    });
  }
  try{ await loadBypasses(); } catch(e){ console.error(e); }

})();
</script>


</body>
</html>
